version: '3.8'

x-kafka_controller:
  &kafka_controller-env
  CLUSTER_ID: 'ciWo7IWazngRchmPES6q5A=='
  KAFKA_PROCESS_ROLES: controller
  KAFKA_CONTROLLER_QUORUM_VOTERS: 4000@kafka-controller-0:4090,5000@kafka-controller-1:5090
  KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:SASL_SSL,INTERNAL:SASL_SSL
  KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
  KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
  KAFKA_AUTO_CREATE_TOPICS_ENABLE: true
  KAFKA_AUTO_LEADER_REBALANCE_ENABLE: true
  KAFKA_UNCLEAN_LEADER_ELECTION_ENABLE: false
  KAFKA_REPLICATION_QUOTA_WINDOW_NUM: 11
  KAFKA_REPLICATION_QUOTA_WINDOW_SIZE_SECONDS: 1
  KAFKA_OPTS: "-Djava.security.auth.login.config=/etc/kafka/kafka_server_jaas.conf"

  # ACL Config
  KAFKA_AUTHORIZER_CLASS_NAME: org.apache.kafka.metadata.authorizer.StandardAuthorizer
  KAFKA_ALLOW_EVERYONE_IF_NO_ACL_FOUND: false
  KAFKA_SUPER_USERS: User:admin

  # SASL Config
  KAFKA_SASL_MECHANISM_CONTROLLER_PROTOCOL: PLAIN
  KAFKA_SASL_MECHANISM_INTER_BROKER_PROTOCOL: PLAIN
  KAFKA_SASL_ENABLED_MECHANISMS: PLAIN
  KAFKA_LISTENER_NAME_CONTROLLER_PLAIN_SASL_JAAS_CONFIG: org.apache.kafka.common.security.plain.PlainLoginModule required username="admin" password="your_password" user_admin="your_password";
  KAFKA_SECURITY_PROTOCOL: 'SASL_SSL'
  # SSL Config
  KAFKA_SSL_KEYSTORE_TYPE: PKCS12
  KAFKA_SSL_TRUSTSTORE_TYPE: JKS
  KAFKA_SSL_KEYSTORE_PASSWORD: your_password
  KAFKA_SSL_KEY_PASSWORD: your_password
  KAFKA_SSL_TRUSTSTORE_PASSWORD: your_password
  KAFKA_SSL_CLIENT_AUTH: required

x-kafka_broker:
  &kafka_broker-env
  KAFKA_PROCESS_ROLES: broker
  CLUSTER_ID: 'ciWo7IWazngRchmPES6q5A=='
  KAFKA_CONTROLLER_QUORUM_VOTERS: 4000@kafka-controller-0:4090,5000@kafka-controller-1:5090
  KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: BROKER:SASL_SSL,CONTROLLER:SASL_SSL,INTERNAL:SASL_SSL,EXTERNAL:SASL_SSL
  KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
  KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
  KAFKA_AUTO_CREATE_TOPICS_ENABLE: true
  KAFKA_AUTO_LEADER_REBALANCE_ENABLE: true
  KAFKA_UNCLEAN_LEADER_ELECTION_ENABLE: false
  KAFKA_REPLICATION_QUOTA_WINDOW_NUM: 11
  KAFKA_REPLICATION_QUOTA_WINDOW_SIZE_SECONDS: 1
  KAFKA_OPTS: "-Djava.security.auth.login.config=/etc/kafka/kafka_server_jaas.conf"

  # SASL Config
  KAFKA_SASL_MECHANISM_INTER_BROKER_PROTOCOL: PLAIN
  KAFKA_SASL_MECHANISM_CONTROLLER_PROTOCOL: PLAIN
  KAFKA_SASL_ENABLED_MECHANISMS: PLAIN
  KAFKA_LISTENER_NAME_BROKER_PLAIN_SASL_JAAS_CONFIG: org.apache.kafka.common.security.plain.PlainLoginModule required username="admin" password="your_password" user_admin="your_password" user_producer="your_password" user_consumer="your_password" user_faust_app="your_password";
  KAFKA_LISTENER_NAME_CONTROLLER_PLAIN_SASL_JAAS_CONFIG: org.apache.kafka.common.security.plain.PlainLoginModule required username="admin" password="your_password" user_admin="your_password" user_producer="your_password" user_consumer="your_password" user_faust_app="your_password";
  KAFKA_SECURITY_PROTOCOL: 'SASL_SSL'

  # SSL Config
  KAFKA_SSL_KEYSTORE_TYPE: PKCS12
  KAFKA_SSL_TRUSTSTORE_TYPE: JKS
  KAFKA_SSL_KEYSTORE_PASSWORD: your_password
  KAFKA_SSL_KEY_PASSWORD: your_password
  KAFKA_SSL_TRUSTSTORE_PASSWORD: your_password
  KAFKA_SSL_CLIENT_AUTH: required

  # ACL Config
  KAFKA_AUTHORIZER_CLASS_NAME: org.apache.kafka.metadata.authorizer.StandardAuthorizer
  KAFKA_ALLOW_EVERYONE_IF_NO_ACL_FOUND: true
  KAFKA_SUPER_USERS: User:admin
  KAFKA_HEAP_OPTS: "-Xmx1G -Xms1G"


services:
  kafka-init:
    image: confluentinc/cp-kafka:7.4.4
    depends_on:
      kafka-1:
        condition: service_healthy
      kafka-b-4:
        condition: service_healthy
    volumes:
      - ./adminclient-configs.conf:/etc/kafka/adminclient-configs.conf
      - ./kafka-1-creds:/etc/kafka/secrets/cluster1
      - ./adminclient-configs-b.conf:/etc/kafka/adminclient-configs-b.conf
      - ./kafka-b-4-creds:/etc/kafka/secrets/cluster2
    entrypoint:
      - /bin/sh
      - -c
      - |
        echo "Создаём топики для cluster1..."
        kafka-topics --bootstrap-server kafka-1:1090 \
          --command-config /etc/kafka/adminclient-configs.conf \
          --create --topic input-products --partitions 3 --replication-factor 3
        kafka-topics --bootstrap-server kafka-1:1090 \
          --command-config /etc/kafka/adminclient-configs.conf \
          --create --topic user-requests --partitions 3 --replication-factor 3
        kafka-topics --bootstrap-server kafka-1:1090 \
          --command-config /etc/kafka/adminclient-configs.conf \
          --create --topic user-responses --partitions 3 --replication-factor 3
        kafka-topics --bootstrap-server kafka-1:1090 \
          --command-config /etc/kafka/adminclient-configs.conf \
          --create --topic products --partitions 3 --replication-factor 3

        echo "Список топиков cluster1:"
        kafka-topics --bootstrap-server kafka-1:1090 \
          --command-config /etc/kafka/adminclient-configs.conf --list

        echo "Настраиваем ACL для cluster1..."
        kafka-acls --bootstrap-server kafka-1:1090 \
          --command-config /etc/kafka/adminclient-configs.conf \
          --add --allow-principal User:producer --operation Write --topic input-products
        kafka-acls --bootstrap-server kafka-1:1090 \
          --command-config /etc/kafka/adminclient-configs.conf \
          --add --allow-principal User:producer --operation Write --topic user-requests
        kafka-acls --bootstrap-server kafka-1:1090 \
          --command-config /etc/kafka/adminclient-configs.conf \
          --add --allow-principal User:producer --operation Write --topic user-responses
        kafka-acls --bootstrap-server kafka-1:1090 \
          --command-config /etc/kafka/adminclient-configs.conf \
          --add --allow-principal User:faust_app --operation Read --topic '*'
        kafka-acls --bootstrap-server kafka-1:1090 \
          --command-config /etc/kafka/adminclient-configs.conf \
          --add --allow-principal User:faust_app --operation Write --topic '*'
        kafka-acls --bootstrap-server kafka-1:1090 \
          --command-config /etc/kafka/adminclient-configs.conf \
          --add --allow-principal User:faust_app --operation Create --topic '*'

        echo "Создаём топики для cluster2..."
        kafka-topics --bootstrap-server kafka-b-4:4092 \
          --command-config /etc/kafka/adminclient-configs-b.conf \
          --create --topic analysis --partitions 3 --replication-factor 3

        echo "Список топиков cluster2:"
        kafka-topics --bootstrap-server kafka-b-4:4092 \
          --command-config /etc/kafka/adminclient-configs-b.conf --list

        echo "Настраиваем ACL для cluster2..."
        kafka-acls --bootstrap-server kafka-b-4:4092 \
          --command-config /etc/kafka/adminclient-configs-b.conf \
          --add --allow-principal User:consumer --operation Read --topic '*'
        kafka-acls --bootstrap-server kafka-b-4:4092 \
          --command-config /etc/kafka/adminclient-configs-b.conf \
          --add --allow-principal User:producer --operation Write --topic analysis

        echo "Инициализация завершена."

  postgres-init:
    image: postgres:16
    depends_on:
      - postgres
    volumes:
      - ./init:/docker-entrypoint-initdb.d
    entrypoint: >
      bash -c "
        until pg_isready -h postgres -U postgres; do
          echo 'waiting for postgres...';
          sleep 2;
        done;
        psql -h postgres -U postgres -d analytics -f /docker-entrypoint-initdb.d/init.sql
      "
    environment:
      PGPASSWORD: postgres

  kafka-connect-init:
    image: curlimages/curl:8.10.1
    depends_on:
      - postgres-init
      - kafka-connect
      - kafka-connect-mm2
    volumes:
      - ./init:/init
    entrypoint: |
      sh -c '
        echo "Waiting for Kafka Connect (8083)...";
        until [ $(curl -s -o /dev/null -w "%{http_code}" http://kafka-connect:8083/connectors) -eq 200 ]; do
          echo "Kafka Connect not ready yet...";
          sleep 5;
        done;
        echo "Registering first connector...";
        curl -s -X POST -H "Content-Type: application/json" \
          --data @/init/connector.json \
          http://kafka-connect:8083/connectors \
          || echo "Connector already exists or failed";

        echo "Waiting for Kafka Connect MM2 (8084)...";
        until [ $(curl -s -o /dev/null -w "%{http_code}" http://connect-mm2:8083/connectors) -eq 200 ]; do
          echo "Kafka Connect MM2 not ready yet...";
          sleep 5;
        done;
        echo "Registering MirrorMaker2 connector...";
        curl -s -X POST -H "Content-Type: application/json" \
          --data @/init/connector-mm2.json \
          http://connect-mm2:8083/connectors \
          || echo "MM2 connector already exists or failed";

        echo "All connectors processed.";
      '

  kafka-controller-0:
    image: confluentinc/cp-kafka:7.4.4
    ports:
      - 4090:4090
      - 4091:4091

    environment:
      <<: *kafka_controller-env
      KAFKA_NODE_ID: 4000
      KAFKA_LISTENERS: CONTROLLER://:4090
      KAFKA_SSL_KEYSTORE_LOCATION: /etc/kafka/secrets/kafka-controller-0.keystore.pkcs12
      KAFKA_SSL_TRUSTSTORE_LOCATION: /etc/kafka/secrets/kafka-controller-0.truststore.jks
    volumes:
      - ./kafka-controller-0-creds:/etc/kafka/secrets
      - ./kafka_server_jaas.conf:/etc/kafka/kafka_server_jaas.conf
      - ./adminclient-configs.conf:/etc/kafka/adminclient-configs.conf
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1536M

  kafka-controller-1:
    image: confluentinc/cp-kafka:7.4.4
    ports:
      - 5090:5090
      - 5091:5091
    environment:
      <<: *kafka_controller-env
      KAFKA_NODE_ID: 5000
      KAFKA_LISTENERS: CONTROLLER://:5090
      KAFKA_SSL_KEYSTORE_LOCATION: /etc/kafka/secrets/kafka-controller-1.keystore.pkcs12
      KAFKA_SSL_TRUSTSTORE_LOCATION: /etc/kafka/secrets/kafka-controller-1.truststore.jks
    volumes:
      - ./kafka-controller-1-creds:/etc/kafka/secrets
      - ./kafka_server_jaas.conf:/etc/kafka/kafka_server_jaas.conf
      - ./adminclient-configs.conf:/etc/kafka/adminclient-configs.conf
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1536M

  kafka-controller-2:
    image: confluentinc/cp-kafka:7.4.4
    ports:
      - 6090:6090
    environment:
      <<: *kafka_controller-env
      CLUSTER_ID: 'ciWo7IWazngRchmPES6q5B=='
      KAFKA_NODE_ID: 6000
      KAFKA_LISTENERS: CONTROLLER://:6090
      KAFKA_CONTROLLER_QUORUM_VOTERS: 6000@kafka-controller-2:6090,7000@kafka-controller-3:7090
      KAFKA_SSL_KEYSTORE_LOCATION: /etc/kafka/secrets/kafka-controller-2.keystore.pkcs12
      KAFKA_SSL_TRUSTSTORE_LOCATION: /etc/kafka/secrets/kafka-controller-2.truststore.jks
    volumes:
      - ./kafka-controller-2-creds:/etc/kafka/secrets
      - ./kafka_server_jaas.conf:/etc/kafka/kafka_server_jaas.conf
      - ./adminclient-configs-b.conf:/etc/kafka/adminclient-configs-b.conf
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1536M

  kafka-controller-3:
    image: confluentinc/cp-kafka:7.4.4
    ports:
      - 7090:7090
    environment:
      <<: *kafka_controller-env
      CLUSTER_ID: 'ciWo7IWazngRchmPES6q5B=='
      KAFKA_NODE_ID: 7000
      KAFKA_LISTENERS: CONTROLLER://:7090
      KAFKA_CONTROLLER_QUORUM_VOTERS: 6000@kafka-controller-2:6090,7000@kafka-controller-3:7090
      KAFKA_SSL_KEYSTORE_LOCATION: /etc/kafka/secrets/kafka-controller-3.keystore.pkcs12
      KAFKA_SSL_TRUSTSTORE_LOCATION: /etc/kafka/secrets/kafka-controller-3.truststore.jks
    volumes:
      - ./kafka-controller-3-creds:/etc/kafka/secrets
      - ./kafka_server_jaas.conf:/etc/kafka/kafka_server_jaas.conf
      - ./adminclient-configs-b.conf:/etc/kafka/adminclient-configs-b.conf
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1536M

  kafka-1:
    image: confluentinc/cp-kafka:7.4.4
    ports:
      - 1090:1090
      - 1091:1091
    volumes:
      - ./kafka-1-creds:/etc/kafka/secrets/cluster1/
      - ./kafka_server_jaas.conf:/etc/kafka/kafka_server_jaas.conf
      - ./adminclient-configs.conf:/etc/kafka/adminclient-configs.conf
    environment:
      <<: *kafka_broker-env
      KAFKA_NODE_ID: 1000
      KAFKA_LISTENERS: BROKER://:1090,INTERNAL://:1092,EXTERNAL://:1091
      KAFKA_ADVERTISED_LISTENERS: BROKER://kafka-1:1090,INTERNAL://kafka-1:1092,EXTERNAL://localhost:1091
      KAFKA_SSL_KEYSTORE_LOCATION: /etc/kafka/secrets/cluster1/kafka.kafka-1.keystore.pkcs12
      KAFKA_SSL_TRUSTSTORE_LOCATION: /etc/kafka/secrets/cluster1/kafka.kafka-1.truststore.jks
      KAFKA_SSL_KEYSTORE_FILENAME: kafka.kafka-1.keystore.pkcs12
      KAFKA_SSL_TRUSTSTORE_FILENAME: kafka.kafka-1.truststore.jks
      KAFKA_SSL_KEYSTORE_CREDENTIALS: kafka-1_keystore_creds
      KAFKA_SSL_KEY_CREDENTIALS: kafka-1_sslkey_creds
      KAFKA_SSL_TRUSTSTORE_CREDENTIALS: kafka-1_truststore_creds
    depends_on:
      - kafka-controller-0
      - kafka-controller-1
    healthcheck:
      test: >
        sh -c "kafka-topics --bootstrap-server localhost:1090 \
              --command-config /etc/kafka/adminclient-configs.conf \
              --list >/dev/null"
      interval: 10s
      timeout: 5s
      retries: 20
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 2G

  kafka-2:
    image: confluentinc/cp-kafka:7.4.4
    ports:
      - 2090:2090
      - 2091:2091

    volumes:
      - ./kafka-2-creds:/etc/kafka/secrets/cluster1/
      - ./kafka_server_jaas.conf:/etc/kafka/kafka_server_jaas.conf
      - ./adminclient-configs.conf:/etc/kafka/adminclient-configs.conf
    environment:
      <<: *kafka_broker-env
      KAFKA_NODE_ID: 2000
      KAFKA_LISTENERS: BROKER://:2090,INTERNAL://:2092,EXTERNAL://:2091
      KAFKA_ADVERTISED_LISTENERS: BROKER://kafka-2:2090,INTERNAL://kafka-2:2092,EXTERNAL://localhost:2091
      KAFKA_SSL_KEYSTORE_LOCATION: /etc/kafka/secrets/cluster1/kafka.kafka-2.keystore.pkcs12
      KAFKA_SSL_TRUSTSTORE_LOCATION: /etc/kafka/secrets/cluster1/kafka.kafka-2.truststore.jks
      KAFKA_SSL_KEYSTORE_FILENAME: kafka.kafka-2.keystore.pkcs12
      KAFKA_SSL_TRUSTSTORE_FILENAME: kafka.kafka-2.truststore.jks
      KAFKA_SSL_KEYSTORE_CREDENTIALS: kafka-2_keystore_creds
      KAFKA_SSL_KEY_CREDENTIALS: kafka-2_sslkey_creds
      KAFKA_SSL_TRUSTSTORE_CREDENTIALS: kafka-2_truststore_creds
    depends_on:
      - kafka-controller-0
      - kafka-controller-1
    healthcheck:
      test: >
        sh -c "kafka-topics --bootstrap-server localhost:1090 \
              --command-config /etc/kafka/adminclient-configs.conf \
              --list >/dev/null"
      interval: 10s
      timeout: 5s
      retries: 20
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 2G

  kafka-3:
    image: confluentinc/cp-kafka:7.4.4
    ports:
      - 3090:3090
      - 3091:3091
    volumes:
      - ./kafka-3-creds:/etc/kafka/secrets/cluster1/
      - ./kafka_server_jaas.conf:/etc/kafka/kafka_server_jaas.conf
      - ./adminclient-configs.conf:/etc/kafka/adminclient-configs.conf
    environment:
      <<: *kafka_broker-env
      KAFKA_NODE_ID: 3000
      KAFKA_LISTENERS: BROKER://:3090,INTERNAL://:3092,EXTERNAL://:3091
      KAFKA_ADVERTISED_LISTENERS: BROKER://kafka-3:3090,INTERNAL://kafka-3:3092,EXTERNAL://localhost:3091
      KAFKA_SSL_KEYSTORE_LOCATION: /etc/kafka/secrets/cluster1/kafka.kafka-3.keystore.pkcs12
      KAFKA_SSL_TRUSTSTORE_LOCATION: /etc/kafka/secrets/cluster1/kafka.kafka-3.truststore.jks
      KAFKA_SSL_KEYSTORE_FILENAME: kafka.kafka-3.keystore.pkcs12
      KAFKA_SSL_TRUSTSTORE_FILENAME: kafka.kafka-3.truststore.jks
      KAFKA_SSL_KEYSTORE_CREDENTIALS: kafka-3_keystore_creds
      KAFKA_SSL_KEY_CREDENTIALS: kafka-3_sslkey_creds
      KAFKA_SSL_TRUSTSTORE_CREDENTIALS: kafka-3_truststore_creds
    depends_on:
      - kafka-controller-0
      - kafka-controller-1
    healthcheck:
      test: >
        sh -c "kafka-topics --bootstrap-server localhost:1090 \
              --command-config /etc/kafka/adminclient-configs.conf \
              --list >/dev/null"
      interval: 10s
      timeout: 5s
      retries: 20
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 2G

  kafka-b-4:
    image: confluentinc/cp-kafka:7.4.4
    ports:
      - 4092:4092
      - 4094:4094
    environment:
      <<: *kafka_broker-env
      CLUSTER_ID: 'ciWo7IWazngRchmPES6q5B=='
      KAFKA_NODE_ID: 4001
      KAFKA_CONTROLLER_QUORUM_VOTERS: 6000@kafka-controller-2:6090,7000@kafka-controller-3:7090
      KAFKA_LISTENERS: BROKER://:4092,INTERNAL://:4093,EXTERNAL://:4094
      KAFKA_ADVERTISED_LISTENERS: BROKER://kafka-b-4:4092,INTERNAL://kafka-b-4:4093,EXTERNAL://localhost:4094
      KAFKA_SSL_KEYSTORE_LOCATION: /etc/kafka/secrets/cluster2/kafka.kafka-b-4.keystore.pkcs12
      KAFKA_SSL_TRUSTSTORE_LOCATION: /etc/kafka/secrets/cluster2/kafka.kafka-b-4.truststore.jks
      KAFKA_SSL_KEYSTORE_FILENAME: kafka.kafka-b-4.keystore.pkcs12
      KAFKA_SSL_TRUSTSTORE_FILENAME: kafka.kafka-b-4.truststore.jks
      KAFKA_SSL_KEYSTORE_CREDENTIALS: kafka-b-4_keystore_creds
      KAFKA_SSL_KEY_CREDENTIALS: kafka-b-4_sslkey_creds
      KAFKA_SSL_TRUSTSTORE_CREDENTIALS: kafka-b-4_truststore_creds
    depends_on:
      - kafka-controller-2
      - kafka-controller-3
    volumes:
      - ./kafka-b-4-creds:/etc/kafka/secrets/cluster2
      - ./kafka_server_jaas.conf:/etc/kafka/kafka_server_jaas.conf
      - ./adminclient-configs-b.conf:/etc/kafka/adminclient-configs-b.conf
    healthcheck:
      test: >
        sh -c "kafka-topics --bootstrap-server localhost:4092 \
              --command-config /etc/kafka/adminclient-configs-b.conf \
              --list >/dev/null"
      interval: 10s
      timeout: 5s
      retries: 20
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 2G

  kafka-b-5:
    image: confluentinc/cp-kafka:7.4.4
    ports:
      - 5092:5092
      - 5094:5094
    environment:
      <<: *kafka_broker-env
      CLUSTER_ID: 'ciWo7IWazngRchmPES6q5B=='
      KAFKA_NODE_ID: 5001
      KAFKA_CONTROLLER_QUORUM_VOTERS: 6000@kafka-controller-2:6090,7000@kafka-controller-3:7090
      KAFKA_LISTENERS: BROKER://:5092,INTERNAL://:5093,EXTERNAL://:5094
      KAFKA_ADVERTISED_LISTENERS: BROKER://kafka-b-5:5092,INTERNAL://kafka-b-5:5093,EXTERNAL://localhost:5094
      KAFKA_SSL_KEYSTORE_LOCATION: /etc/kafka/secrets/cluster2/kafka.kafka-b-5.keystore.pkcs12
      KAFKA_SSL_TRUSTSTORE_LOCATION: /etc/kafka/secrets/cluster2/kafka.kafka-b-5.truststore.jks
      KAFKA_SSL_KEYSTORE_FILENAME: kafka.kafka-b-5.keystore.pkcs12
      KAFKA_SSL_TRUSTSTORE_FILENAME: kafka.kafka-b-5.truststore.jks
      KAFKA_SSL_KEYSTORE_CREDENTIALS: kafka-b-5_keystore_creds
      KAFKA_SSL_KEY_CREDENTIALS: kafka-b-5_sslkey_creds
      KAFKA_SSL_TRUSTSTORE_CREDENTIALS: kafka-b-5_truststore_creds
    depends_on:
      - kafka-controller-2
      - kafka-controller-3
    volumes:
      - ./kafka-b-5-creds:/etc/kafka/secrets/cluster2
      - ./kafka_server_jaas.conf:/etc/kafka/kafka_server_jaas.conf
      - ./adminclient-configs-b.conf:/etc/kafka/adminclient-configs-b.conf
    healthcheck:
      test: >
        sh -c "kafka-topics --bootstrap-server localhost:4092 \
              --command-config /etc/kafka/adminclient-configs-b.conf \
              --list >/dev/null"
      interval: 10s
      timeout: 5s
      retries: 20
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 2G

  kafka-b-6:
    image: confluentinc/cp-kafka:7.4.4
    ports:
      - 6092:6092
      - 6094:6094
    environment:
      <<: *kafka_broker-env
      CLUSTER_ID: 'ciWo7IWazngRchmPES6q5B=='
      KAFKA_NODE_ID: 6001
      KAFKA_CONTROLLER_QUORUM_VOTERS: 6000@kafka-controller-2:6090,7000@kafka-controller-3:7090
      KAFKA_LISTENERS: BROKER://:6092,INTERNAL://:6093,EXTERNAL://:6094
      KAFKA_ADVERTISED_LISTENERS: BROKER://kafka-b-6:6092,INTERNAL://kafka-b-6:6093,EXTERNAL://localhost:6094
      KAFKA_SSL_KEYSTORE_LOCATION: /etc/kafka/secrets/cluster2/kafka.kafka-b-6.keystore.pkcs12
      KAFKA_SSL_TRUSTSTORE_LOCATION: /etc/kafka/secrets/cluster2/kafka.kafka-b-6.truststore.jks
      KAFKA_SSL_KEYSTORE_FILENAME: kafka.kafka-b-6.keystore.pkcs12
      KAFKA_SSL_TRUSTSTORE_FILENAME: kafka.kafka-b-6.truststore.jks
      KAFKA_SSL_KEYSTORE_CREDENTIALS: kafka-b-6_keystore_creds
      KAFKA_SSL_KEY_CREDENTIALS: kafka-b-6_sslkey_creds
      KAFKA_SSL_TRUSTSTORE_CREDENTIALS: kafka-b-6_truststore_creds
    depends_on:
      - kafka-controller-2
      - kafka-controller-3
    volumes:
      - ./kafka-b-6-creds:/etc/kafka/secrets/cluster2
      - ./kafka_server_jaas.conf:/etc/kafka/kafka_server_jaas.conf
      - ./adminclient-configs-b.conf:/etc/kafka/adminclient-configs-b.conf
    healthcheck:
      test: >
        sh -c "kafka-topics --bootstrap-server localhost:4092 \
              --command-config /etc/kafka/adminclient-configs-b.conf \
              --list >/dev/null"
      interval: 10s
      timeout: 5s
      retries: 20
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 2G

  schema-registry:
    image: confluentinc/cp-schema-registry:7.4.4
    container_name: schema-registry
    depends_on:
      - kafka-1
    ports:
      - "8081:8081"
    environment:
      SCHEMA_REGISTRY_HOST_NAME: schema-registry
      SCHEMA_REGISTRY_LISTENERS: http://0.0.0.0:8081
      SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS: SASL_SSL://kafka-1:1092
      SCHEMA_REGISTRY_KAFKASTORE_SECURITY_PROTOCOL: SASL_SSL
      SCHEMA_REGISTRY_KAFKASTORE_SASL_MECHANISM: PLAIN
      SCHEMA_REGISTRY_KAFKASTORE_SASL_JAAS_CONFIG: >
        org.apache.kafka.common.security.plain.PlainLoginModule required
        username="admin" password="your_password";
      SCHEMA_REGISTRY_KAFKASTORE_SSL_TRUSTSTORE_LOCATION: /etc/kafka/secrets/kafka.kafka-1.truststore.jks
      SCHEMA_REGISTRY_KAFKASTORE_SSL_TRUSTSTORE_PASSWORD: your_password
      SCHEMA_REGISTRY_KAFKASTORE_SSL_KEYSTORE_LOCATION: /etc/kafka/secrets/kafka.kafka-1.keystore.pkcs12
      SCHEMA_REGISTRY_KAFKASTORE_SSL_KEYSTORE_PASSWORD: your_password
      SCHEMA_REGISTRY_KAFKASTORE_SSL_KEY_PASSWORD: your_password
      KAFKA_OPTS: "-Djava.security.auth.login.config=/etc/kafka/kafka_server_jaas.conf"
    volumes:
      - ./kafka-1-creds:/etc/kafka/secrets
      - ./kafka_server_jaas.conf:/etc/kafka/kafka_server_jaas.conf
      - ./adminclient-configs.conf:/etc/kafka/adminclient-configs.conf
    deploy:
      resources:
        limits:
          memory: 1536M

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    depends_on:
      - kafka-1
      - schema-registry
    ports:
      - "8080:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka-1:1092
      KAFKA_CLUSTERS_0_PROPERTIES_SECURITY_PROTOCOL: SASL_SSL
      KAFKA_CLUSTERS_0_PROPERTIES_SASL_MECHANISM: PLAIN
      KAFKA_CLUSTERS_0_PROPERTIES_SASL_JAAS_CONFIG: org.apache.kafka.common.security.plain.PlainLoginModule required username="admin" password="your_password";
      KAFKA_CLUSTERS_0_PROPERTIES_SSL_TRUSTSTORE_LOCATION: /etc/kafka/secrets/kafka.kafka-1.truststore.jks
      KAFKA_CLUSTERS_0_PROPERTIES_SSL_TRUSTSTORE_PASSWORD: your_password
      KAFKA_CLUSTERS_0_SSL_KEYSTORE_LOCATION: /etc/kafka/secrets/kafka.kafka-1.keystore.pkcs12
      KAFKA_CLUSTERS_0_SSL_KEYSTORE_PASSWORD: your_password
      KAFKA_CLUSTERS_0_SSL_KEY_PASSWORD: your_password
      KAFKA_CLUSTERS_0_SCHEMAREGISTRY: http://schema-registry:8081
    volumes:
      - ./kafka-1-creds:/etc/kafka/secrets
    deploy:
      resources:
        limits:
          memory: 2G

  postgres:
   image: debezium/postgres:16
   hostname: postgres
   container_name: postgres
   ports:
     - "5432:5432"
   environment:
     POSTGRES_USER: postgres
     POSTGRES_PASSWORD: postgres
     POSTGRES_DB: analytics
   volumes:
     - ./postgres/custom-config.conf:/etc/postgresql/postgresql.conf
   command: postgres -c config_file=/etc/postgresql/postgresql.conf
   deploy:
     resources:
       limits:
         memory: 1G

  kafka-connect:
   build:
     context: ./kafka-connect
   ports:
     - "8083:8083"  # REST API Kafka Connect
     - "9875:9875"
     - "9876:9876"
   depends_on:
     - kafka-1
     - kafka-2
     - kafka-3
     - schema-registry
     - postgres
   environment:
     CONNECT_BOOTSTRAP_SERVERS: kafka-1:1092
     CONNECT_REST_PORT: 8083
     CONNECT_GROUP_ID: 'kafka-connect'
     CONNECT_REST_ADVERTISED_HOST_NAME: 'localhost'

     # Хранение конфигурации, смещений и статусов
     CONNECT_CONFIG_STORAGE_TOPIC: 'connect-config-storage'
     CONNECT_OFFSET_STORAGE_TOPIC: 'connect-offset-storage'
     CONNECT_STATUS_STORAGE_TOPIC: 'connect-status-storage'
     CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR: 1
     CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR: 1
     CONNECT_STATUS_STORAGE_REPLICATION_FACTOR: 1

     # SSL
     CONNECT_SECURITY_PROTOCOL: SASL_SSL
     CONNECT_SASL_MECHANISM: PLAIN
     CONNECT_SASL_JAAS_CONFIG: org.apache.kafka.common.security.plain.PlainLoginModule required username="admin" password="your_password";
     CONNECT_SSL_TRUSTSTORE_LOCATION: /etc/kafka/secrets/kafka.kafka-1.truststore.jks
     CONNECT_SSL_TRUSTSTORE_PASSWORD: your_password

     # Конвертеры
     CONNECT_KEY_CONVERTER: "org.apache.kafka.connect.storage.StringConverter"
     CONNECT_VALUE_CONVERTER: "org.apache.kafka.connect.json.JsonConverter"
     CONNECT_INTERNAL_KEY_CONVERTER: "org.apache.kafka.connect.json.JsonConverter"
     CONNECT_INTERNAL_VALUE_CONVERTER: "org.apache.kafka.connect.json.JsonConverter"

     CONNECT_VALUE_CONVERTER_SCHEMA_REGISTRY_URL: 'http://schema-registry:8081'
     CONNECT_KEY_CONVERTER_SCHEMA_REGISTRY_URL: 'http://schema-registry:8081'
     # Export JMX metrics to :9876/metrics for Prometheus
     KAFKA_JMX_PORT: '9875'
     KAFKA_OPTS: "-javaagent:/opt/jmx_prometheus_javaagent-0.15.0.jar=9876:/opt/kafka-connect.yml"
     # Read connection password from file
     CONNECT_CONFIG_PROVIDERS: "file"
     CONNECT_CONFIG_PROVIDERS_FILE_CLASS: "org.apache.kafka.common.config.provider.FileConfigProvider"
     # Пути к плагинам
     CONNECT_PLUGIN_PATH: /usr/share/java,/kafka-connect/jars
   volumes:
     - ./confluent-hub-components/:/kafka-connect/jars
     - ./kafka-1-creds:/etc/kafka/secrets

  kafka-connect-mm2:
    image: confluentinc/cp-kafka-connect:7.9.2
    container_name: connect-mm2
    ports:
      - "8084:8083"
    depends_on:
      - kafka-b-4
      - kafka-b-5
      - kafka-b-6
    environment:
      CONNECT_BOOTSTRAP_SERVERS: 'kafka-b-4:4093,kafka-b-5:5093,kafka-b-6:6093'
      CONNECT_REST_ADVERTISED_HOST_NAME: localhost
      CONNECT_GROUP_ID: mirror-maker-2
      CONNECT_CONFIG_STORAGE_TOPIC: mm2-configs
      CONNECT_OFFSET_STORAGE_TOPIC: mm2-offsets
      CONNECT_STATUS_STORAGE_TOPIC: mm2-status
      CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR: 1
      CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR: 1
      CONNECT_STATUS_STORAGE_REPLICATION_FACTOR: 1
      CONNECT_KEY_CONVERTER: org.apache.kafka.connect.converters.ByteArrayConverter
      CONNECT_VALUE_CONVERTER: org.apache.kafka.connect.converters.ByteArrayConverter
      CONNECT_INTERNAL_KEY_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      CONNECT_INTERNAL_VALUE_CONVERTER: org.apache.kafka.connect.json.JsonConverter

      # Общая безопасность
      CONNECT_SECURITY_PROTOCOL: SASL_SSL
      CONNECT_SASL_MECHANISM: PLAIN
      CONNECT_SASL_JAAS_CONFIG: >
        org.apache.kafka.common.security.plain.PlainLoginModule required
        username="admin"
        password="your_password";

      # SSL
      CONNECT_SSL_TRUSTSTORE_LOCATION: /etc/kafka/secrets/cluster1/kafka.kafka-1.truststore.jks
      CONNECT_SSL_TRUSTSTORE_PASSWORD: your_password
      CONNECT_SSL_KEYSTORE_LOCATION: /etc/kafka/secrets/cluster1/kafka.kafka-1.keystore.pkcs12
      CONNECT_SSL_KEYSTORE_PASSWORD: your_password

      # Producer настройки для MirrorMaker2 (под target cluster)
      CONNECT_PRODUCER_SECURITY_PROTOCOL: SASL_SSL
      CONNECT_PRODUCER_SASL_MECHANISM: PLAIN
      CONNECT_PRODUCER_SASL_JAAS_CONFIG: >
        org.apache.kafka.common.security.plain.PlainLoginModule required
        username="admin"
        password="your_password";
      CONNECT_PRODUCER_SSL_TRUSTSTORE_LOCATION: /etc/kafka/secrets/cluster2/kafka.kafka-b-4.truststore.jks
      CONNECT_PRODUCER_SSL_TRUSTSTORE_PASSWORD: your_password
      CONNECT_PRODUCER_SSL_KEYSTORE_LOCATION: /etc/kafka/secrets/cluster2/kafka.kafka-b-4.keystore.pkcs12
      CONNECT_PRODUCER_SSL_KEYSTORE_PASSWORD: your_password

      # Consumer настройки для MirrorMaker2 (под source cluster)
      CONNECT_CONSUMER_SECURITY_PROTOCOL: SASL_SSL
      CONNECT_CONSUMER_SASL_MECHANISM: PLAIN
      CONNECT_CONSUMER_SASL_JAAS_CONFIG: >
        org.apache.kafka.common.security.plain.PlainLoginModule required
        username="admin"
        password="your_password";
      CONNECT_CONSUMER_SSL_TRUSTSTORE_LOCATION: /etc/kafka/secrets/cluster1/kafka.kafka-1.truststore.jks
      CONNECT_CONSUMER_SSL_TRUSTSTORE_PASSWORD: your_password
      CONNECT_CONSUMER_SSL_KEYSTORE_LOCATION: /etc/kafka/secrets/cluster1/kafka.kafka-1.keystore.pkcs12
      CONNECT_CONSUMER_SSL_KEYSTORE_PASSWORD: your_password

      CONNECT_PLUGIN_PATH: /usr/share/java
    volumes:
      - ./kafka-1-creds:/etc/kafka/secrets/cluster1
      - ./kafka-b-4-creds:/etc/kafka/secrets/cluster2
      - ./adminclient-configs-b.conf:/etc/kafka/adminclient-configs-b.conf
    deploy:
      resources:
        limits:
          memory: 1536M

  hadoop-namenode:
    image: apache/hadoop:3.4.1
    container_name: hadoop-namenode
    hostname: hadoop-namenode
    user: "root"
    restart: always
    platform: linux/amd64
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1536M
    shm_size: 10G
    ports:
      - "9870:9870"
      - "9000:9000"
    volumes:
      - ./config/core-site.xml:/opt/hadoop/etc/hadoop/core-site.xml
      - ./config/hdfs-site-namenode.xml:/opt/hadoop/etc/hadoop/hdfs-site.xml
      - ./namenode_entrypoint.sh:/namenode_entrypoint.sh
    entrypoint: [ "/bin/bash", "/namenode_entrypoint.sh" ]
    command: [ "hdfs", "namenode" ]


  hadoop-datanode-1:
    image: apache/hadoop:3.4.1
    container_name: hadoop-datanode-1
    hostname: hadoop-datanode-1
    user: "root"
    restart: always
    platform: linux/amd64
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1536M
    shm_size: 10G
    depends_on:
      - hadoop-namenode
    ports:
      - "9864:9864"
      - "9970:9970"
    volumes:
      - ./config/core-site.xml:/opt/hadoop/etc/hadoop/core-site.xml
      - ./config/hdfs-site-datanode-1.xml:/opt/hadoop/etc/hadoop/hdfs-site.xml
      - ./datanode_entrypoint.sh:/datanode_entrypoint.sh
    entrypoint: [ "/bin/bash", "/datanode_entrypoint.sh" ]
    command: [ "hdfs", "datanode" ]


  spark-master:
    image: apache/spark:3.5.4
    container_name: spark-master
    hostname: spark-master
    ports:
      - "8085:8080"
      - "7077:7077"
    command: [ "/opt/spark/bin/spark-class", "org.apache.spark.deploy.master.Master", "--host", "spark-master" ]
    environment:
      - SPARK_NO_DAEMONIZE=true
    restart: always

  spark-worker-1:
    image: apache/spark:3.5.4
    container_name: spark-worker-1
    hostname: spark-worker-1
    depends_on:
      - spark-master
    environment:
      - SPARK_NO_DAEMONIZE=true
    command: [ "/opt/spark/bin/spark-class", "org.apache.spark.deploy.worker.Worker", "spark://spark-master:7077" ]
    restart: always

  prometheus:
    image: prom/prometheus:v2.30.3
    ports:
      - 9090:9090
    volumes:
      - ./prometheus:/etc/prometheus
    command: --web.enable-lifecycle --config.file=/etc/prometheus/prometheus.yml
    links:
      - kafka-connect

  grafana:
    build:
      context: ./grafana
    ports:
      - 3000:3000
